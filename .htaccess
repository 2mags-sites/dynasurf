# Dynasurf Website - Apache Configuration

# Security Headers
<IfModule mod_headers.c>
    Header set X-Content-Type-Options "nosniff"
    Header set X-Frame-Options "SAMEORIGIN"
    Header set X-XSS-Protection "1; mode=block"
    Header set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# Protect sensitive files
<FilesMatch "\.(env|json|log|md|gitignore|lock)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Protect .env file specifically
<Files .env>
    Order allow,deny
    Deny from all
</Files>

# Block all dot files
<FilesMatch "^\.">
    Order allow,deny
    Deny from all
</FilesMatch>

# Protect includes directory and URL rewrites
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /

    # Allow JavaScript files from includes directory (needed for admin mode)
    RewriteCond %{REQUEST_URI} ^/includes/.*\.js$ [NC]
    RewriteRule ^ - [L]

    # Block access to includes, content, and cache directories (except JS files)
    RewriteRule ^(includes|content|cache)/ - [F,L]

    # Admin files (admin-save.php, admin-upload.php) have their own PHP authentication
    # Do not block them here - they check isAdminMode() internally

    # Clean URLs - Remove .php extension
    # Redirect /page.php to /page (external redirect)
    RewriteCond %{THE_REQUEST} \s/([^.]+)\.php[\s?] [NC]
    RewriteCond %{REQUEST_URI} !^/(admin-save|admin-upload|contact-handler|download-content) [NC]
    RewriteRule ^ /%1 [R=301,L]

    # Internally rewrite /page to /page.php
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME}.php -f
    RewriteRule ^([^/]+)/?$ $1.php [L]

    # Redirect old /news/[slug] URLs to /blog/[slug]
    # Excludes WordPress system paths so /news/wp-admin, /news/wp-json etc still work
    RewriteCond %{REQUEST_URI} ^/news/([a-z0-9\-]+)/?$ [NC]
    RewriteCond %{REQUEST_URI} !^/news/wp- [NC]
    RewriteCond %{REQUEST_URI} !^/news/feed [NC]
    RewriteCond %{REQUEST_URI} !^/news/category [NC]
    RewriteCond %{REQUEST_URI} !^/news/tag [NC]
    RewriteCond %{REQUEST_URI} !^/news/author [NC]
    RewriteCond %{REQUEST_URI} !^/news/page [NC]
    RewriteRule ^news/([a-z0-9\-]+)/?$ /blog/$1 [R=301,L]

    # Blog URL Rewrites
    # /blog/ -> blog.php (listing page)
    RewriteRule ^blog/?$ blog.php [L,QSA]

    # /blog/page/2/ -> blog.php?page=2 (pagination)
    RewriteRule ^blog/page/([0-9]+)/?$ blog.php?page=$1 [L,QSA]

    # /blog/post-slug -> blog-post.php?slug=post-slug (single post)
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^blog/([a-zA-Z0-9\-]+)/?$ blog-post.php?slug=$1 [L,QSA]
</IfModule>

# Disable directory browsing
Options -Indexes

# Protect uploads directory (allow images only)
<Directory "assets/images/uploads">
    # Only allow specific file types
    <FilesMatch "\.(gif|jpe?g|png|webp)$">
        Order Allow,Deny
        Allow from all
    </FilesMatch>
</Directory>

# Enable compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
</IfModule>

# Cache control
<IfModule mod_expires.c>
    ExpiresActive On

    # Images
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/webp "access plus 1 month"

    # CSS and JavaScript
    ExpiresByType text/css "access plus 1 week"
    ExpiresByType application/javascript "access plus 1 week"

    # HTML
    ExpiresByType text/html "access plus 1 hour"
</IfModule>

# Default charset
AddDefaultCharset UTF-8

# Error pages (optional - create these if needed)
ErrorDocument 404 /404.php
ErrorDocument 403 /403.php
ErrorDocument 500 /500.php

# PHP settings (if allowed)
<IfModule mod_php.c>
    php_value upload_max_filesize 10M
    php_value post_max_size 10M
    php_value max_execution_time 300
    php_value max_input_time 300
</IfModule>